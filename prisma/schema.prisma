generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id             String          @id @default(uuid())
  username       String          @unique
  password       String
  name           String
  image          String?         @db.LongText
  role           Role            @default(ACCOUNTANT)
  agencyId       String?
  warehouseId    String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  pricingType    String?
  createdRecords AccountRecord[]
  customers      Customer[]      @relation("RepCustomers")
  transactions   Transaction[]
  agency         Agency?         @relation(fields: [agencyId], references: [id])
  warehouse      Warehouse?      @relation(fields: [warehouseId], references: [id])
  agencies       Agency[]        @relation("UserAgencies")
  journalEntries JournalEntry[]
  dailyClosings  DailyClosing[]

  @@index([agencyId], map: "User_agencyId_fkey")
  @@index([warehouseId], map: "User_warehouseId_fkey")
}

model Agency {
  id           String          @id @default(uuid())
  name         String
  address      String?
  phone        String?
  image        String?         @db.LongText
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  accounts     AccountRecord[]
  customers    Customer[]
  products     Product[]
  transactions Transaction[]
  directUsers  User[]
  warehouses   Warehouse[]
  users        User[]          @relation("UserAgencies")
  suppliers    Supplier[]
  banks        Bank[]
  journalEntries JournalEntry[]
  dailyClosings  DailyClosing[]
}

model Supplier {
  id        String   @id @default(uuid())
  name      String
  phone     String?
  address   String?
  agencyId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  agency    Agency   @relation(fields: [agencyId], references: [id])
  products  Product[]
  transactions Transaction[]
  accounts  AccountRecord[]

  @@index([agencyId])
}

model Warehouse {
  id           String        @id @default(uuid())
  name         String
  agencyId     String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  stock        Stock[]
  transactions Transaction[]
  users        User[]
  agency       Agency        @relation(fields: [agencyId], references: [id], onDelete: Cascade)

  @@index([agencyId], map: "Warehouse_agencyId_fkey")
}

model Product {
  id               String            @id @default(uuid())
  name             String
  description      String?
  barcode          String?           @unique
  factoryPrice     Decimal
  wholesalePrice   Decimal
  retailPrice      Decimal
  agencyId         String
  supplierId       String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  image            String?           @db.LongText
  unitsPerCarton   Int               @default(1)
  unitFactoryPrice Decimal           @default(0)
  unitWholesalePrice Decimal         @default(0)
  unitRetailPrice   Decimal          @default(0)
  agency           Agency            @relation(fields: [agencyId], references: [id])
  supplier         Supplier?         @relation(fields: [supplierId], references: [id])
  stocks           Stock[]
  transactionItems TransactionItem[]

  @@index([agencyId], map: "Product_agencyId_fkey")
  @@index([supplierId])
}

model Stock {
  id          String    @id @default(uuid())
  warehouseId String
  productId   String
  quantity    Int       @default(0)
  product     Product   @relation(fields: [productId], references: [id])
  warehouse   Warehouse @relation(fields: [warehouseId], references: [id])

  @@unique([warehouseId, productId])
  @@index([productId], map: "Stock_productId_fkey")
}

model Transaction {
  id              String            @id @default(uuid())
  type            TransactionType
  totalAmount     Decimal
  userId          String
  agencyId        String
  warehouseId     String?
  customerId      String?
  supplierId      String?
  paymentType     PaymentType       @default(CASH)
  paidAmount      Decimal?
  remainingAmount Decimal?
  note            String?
  status          TransactionStatus @default(ACTIVE)
  createdAt       DateTime          @default(now())
  imageUrl        String?           @db.LongText
  agency          Agency            @relation(fields: [agencyId], references: [id])
  customer        Customer?         @relation(fields: [customerId], references: [id])
  supplier        Supplier?         @relation(fields: [supplierId], references: [id])
  user            User              @relation(fields: [userId], references: [id])
  warehouse       Warehouse?        @relation(fields: [warehouseId], references: [id])
  items           TransactionItem[]

  @@index([agencyId], map: "Transaction_agencyId_fkey")
  @@index([customerId], map: "Transaction_customerId_fkey")
  @@index([userId], map: "Transaction_userId_fkey")
  @@index([warehouseId], map: "Transaction_warehouseId_fkey")
  @@index([supplierId])
}

model Customer {
  id               String        @id @default(uuid())
  name             String
  phone            String?
  address          String?
  representativeId String
  agencyId         String
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  agency           Agency        @relation(fields: [agencyId], references: [id])
  representative   User          @relation("RepCustomers", fields: [representativeId], references: [id])
  transactions     Transaction[]
  accounts         AccountRecord[]

  @@index([agencyId], map: "Customer_agencyId_fkey")
  @@index([representativeId], map: "Customer_representativeId_fkey")
}

model TransactionItem {
  id            String      @id @default(uuid())
  transactionId String
  productId     String
  quantity      Int
  price         Decimal
  createdAt     DateTime    @default(now())
  cost          Decimal     @default(0.000000000000000000000000000000)
  product       Product     @relation(fields: [productId], references: [id])
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([productId], map: "TransactionItem_productId_fkey")
  @@index([transactionId], map: "TransactionItem_transactionId_fkey")
}

model AccountRecord {
  id          String            @id @default(uuid())
  type        AccountRecordType
  amount      Decimal
  description String
  agencyId    String?
  userId      String
  supplierId  String?
  customerId  String?
  createdAt   DateTime          @default(now())
  category    String?
  imageUrl    String?           @db.LongText
  agency      Agency?           @relation(fields: [agencyId], references: [id])
  createdBy   User              @relation(fields: [userId], references: [id])
  supplier    Supplier?         @relation(fields: [supplierId], references: [id])
  customer    Customer?         @relation(fields: [customerId], references: [id])

  @@index([agencyId], map: "AccountRecord_agencyId_fkey")
  @@index([userId], map: "AccountRecord_userId_fkey")
  @@index([supplierId])
  @@index([customerId])
}

model Bank {
  id            String            @id @default(uuid())
  name          String
  accountNumber String?
  agencyId      String?
  balance       Decimal           @default(0.000000000000000000000000000000)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  transactions  BankTransaction[]
  loans         Loan[]
  agency        Agency?           @relation(fields: [agencyId], references: [id])

  @@index([agencyId])
}

model BankTransaction {
  id          String              @id @default(uuid())
  amount      Decimal
  type        BankTransactionType
  description String
  date        DateTime            @default(now())
  bankId      String
  imageUrl    String?             @db.LongText
  bank        Bank                @relation(fields: [bankId], references: [id])

  @@index([bankId], map: "BankTransaction_bankId_fkey")
}

model Loan {
  id           String        @id @default(uuid())
  bankId       String
  principal    Decimal
  interest     Decimal       @default(0.000000000000000000000000000000)
  totalAmount  Decimal
  startDate    DateTime
  endDate      DateTime?
  status       LoanStatus    @default(ACTIVE)
  notes        String?
  createdAt    DateTime      @default(now())
  installments Installment[]
  bank         Bank          @relation(fields: [bankId], references: [id])

  @@index([bankId], map: "Loan_bankId_fkey")
}

model Installment {
  id       String            @id @default(uuid())
  loanId   String
  dueDate  DateTime
  amount   Decimal
  status   InstallmentStatus @default(PENDING)
  paidDate DateTime?
  loan     Loan              @relation(fields: [loanId], references: [id])

  @@index([loanId], map: "Installment_loanId_fkey")
}

enum Role {
  ADMIN
  MANAGER
  SECURITY
  ACCOUNTANT
  WAREHOUSE_KEEPER
  SALES_REPRESENTATIVE
  SALES_RECORDER
}

enum TransactionStatus {
  ACTIVE
  CANCELED
}

enum PaymentType {
  CASH
  CREDIT
  PARTIAL
}

enum TransactionType {
  SALE
  PURCHASE
  RETURN_IN
  RETURN_OUT
  COLLECTION
  SUPPLY_PAYMENT
  INITIAL_STOCK
}

enum AccountRecordType {
  INCOME
  EXPENSE
}

enum BankTransactionType {
  DEPOSIT
  WITHDRAWAL
}

enum LoanStatus {
  ACTIVE
  PAID
  CLOSED
}

enum InstallmentStatus {
  PENDING
  PAID
  OVERDUE
}

model JournalEntry {
  id              String            @id @default(uuid())
  amount          Decimal
  type            JournalEntryType
  description     String
  referenceId     String?           // ID of the original transaction or record
  referenceType   String?           // "SALE", "PURCHASE", "EXPENSE", etc.
  agencyId        String?
  userId          String            // The user who performed the entry
  createdAt       DateTime          @default(now())
  
  agency          Agency?           @relation(fields: [agencyId], references: [id])
  user            User              @relation(fields: [userId], references: [id])

  @@index([agencyId])
  @@index([userId])
  @@index([referenceId])
}

model DailyClosing {
  id              String            @id @default(uuid())
  userId          String            // The representative or accountant
  agencyId        String
  openingBalance  Decimal
  closingBalance  Decimal?          // Actual cash reported
  expectedBalance Decimal?          // System calculated balance
  status          ClosingStatus     @default(OPEN)
  notes           String?
  createdAt       DateTime          @default(now())
  closedAt        DateTime?

  agency          Agency            @relation(fields: [agencyId], references: [id])
  user            User              @relation(fields: [userId], references: [id])

  @@index([agencyId])
  @@index([userId])
}

enum JournalEntryType {
  DEBIT   // Cash In
  CREDIT  // Cash Out
}

enum ClosingStatus {
  OPEN
  CLOSED
  RECONCILED
}
